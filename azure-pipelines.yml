
# Docker
# Build and push an image to Azure Container Registry
# https://docs.microsoft.com/azure/devops/pipelines/languages/docker

trigger:
- master

resources:
- repo: self

variables:
  # Container registry service connection established during pipeline creation
  dockerRegistryServiceConnection: 'e8cadd83-6ab8-468e-ae5c-6670ebb1fd0a'
  imageRepository: 'azuregitops'
  containerRegistry: 'mycr07.azurecr.io'
  dockerfilePath: '$(Build.SourcesDirectory)/Azure-gitops/Dockerfile'
  tag: '$(Build.BuildId)'

  # Agent VM image name
  vmImageName: 'ubuntu-latest'

stages:
- stage: Build
  displayName: Build and push stage
  jobs:
  - job: Build
    displayName: Build
    pool:
      vmImage: $(vmImageName)
    steps:
    - task: Docker@2
      displayName: Build and push an image to container registry
      inputs:
        command: buildAndPush
        repository: $(imageRepository)
        dockerfile: $(dockerfilePath)
        containerRegistry: $(dockerRegistryServiceConnection)
        tags: |
          $(tag)

- stage: STAGING
  displayName: Build and push stage from STAGING
  jobs:
  - job: Build
    displayName: Build
    pool:
      vmImage: $(vmImageName)
    steps:
    - task: Docker@2
      displayName: Build and push an image to container registry
      inputs:
        command: buildAndPush
        repository: $(imageRepository)
        dockerfile: $(dockerfilePath)
        containerRegistry: $(dockerRegistryServiceConnection)
        tags: |
          $(tag)

- stage: PROD
  displayName: Build and push stage from PROD
  jobs:
  - job: Build
    displayName: Build
    pool:
      vmImage: $(vmImageName)
    steps:
    - task: Docker@2
      displayName: Build and push an image to container registry
      inputs:
        command: buildAndPush
        repository: $(imageRepository)
        dockerfile: $(dockerfilePath)
        containerRegistry: $(dockerRegistryServiceConnection)
        tags: |
          $(tag)
    - script: |
        pwd
        echo 'Updating Kubernetes deployment file...'
        # Set git user configuration
        git config --global user.email "subhashchandrasc052@gmail.com"
        git config --global user.name "subhash36"

        # Replace placeholder with current build number
        BUILD_NUMBER=$(tag)
        sed -i "s/replaceImageTag/$BUILD_NUMBER/g" Azure_Gitops/test.yaml

        # Add and commit changes
        git add Azure_Gitops/test.yaml
        git commit -m "Update deployment image to version $BUILD_NUMBER"

        # Modify the remote URL to point to the different repository
        git remote set-url origin https://github.com/subhash36/Azure_GitOps_Argo.git

        # Push changes to remote repository
        git push origin HEAD:master 
  